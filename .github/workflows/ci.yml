# =============================================================================
# Gooey CI Pipeline
# =============================================================================
# Runs on push to main, pull requests, and manual triggers.
#
# Jobs:
#   - test-linux: Run unit tests on Linux
#   - test-macos: Run unit tests on macOS
#   - build-linux: Build all optimization levels on Linux
#   - build-macos: Build all optimization levels on macOS
#   - build-wasm: Build WebAssembly targets
#   - valgrind: Memory leak detection (Linux only)
#   - zig-fmt: Code formatting check
# =============================================================================

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: {}

# Cancel in-progress runs for the same branch (except main)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name != 'main' && github.ref || github.run_id }}
  cancel-in-progress: true

env:
  ZIG_VERSION: "0.15.2"

jobs:
  # ==========================================================================
  # Required Checks Summary
  # ==========================================================================
  required:
    name: "Required Checks"
    runs-on: ubuntu-latest
    needs:
      - test-linux
      - test-macos
      - build-linux
      - build-macos
      - build-wasm
      - valgrind
      - zig-fmt
      - bench-macos
    if: always()
    steps:
      - name: Determine status
        id: status
        run: |
          results='${{ toJSON(needs.*.result) }}'
          if echo "$results" | grep -qE '"(failure|cancelled)"'; then
            echo "result=failed" >> $GITHUB_OUTPUT
          else
            echo "result=success" >> $GITHUB_OUTPUT
          fi
          {
            echo 'results<<EOF'
            echo "$results"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Check for failed status
        if: steps.status.outputs.result != 'success'
        run: |
          echo "One or more required jobs failed: ${{ steps.status.outputs.results }}"
          exit 1

      - name: All checks passed
        run: echo "All required checks passed!"

  # ==========================================================================
  # Linux Tests
  # ==========================================================================
  test-linux:
    name: Test (Linux)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libvulkan-dev \
            libwayland-dev \
            libfreetype-dev \
            libharfbuzz-dev \
            libfontconfig-dev \
            libpng-dev \
            libdbus-1-dev

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Cache Zig
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/zig
            zig-cache
          key: zig-cache-linux-${{ hashFiles('build.zig', 'build.zig.zon') }}
          restore-keys: |
            zig-cache-linux-

      - name: Run tests
        run: zig build test -Dskip-shader-compile=true

  # ==========================================================================
  # macOS Tests
  # ==========================================================================
  test-macos:
    name: Test (macOS)
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Cache Zig
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/zig
            zig-cache
          key: zig-cache-macos-${{ hashFiles('build.zig', 'build.zig.zon') }}
          restore-keys: |
            zig-cache-macos-

      - name: Run tests
        run: zig build test

  # ==========================================================================
  # Linux Build (Multiple Optimization Levels)
  # ==========================================================================
  build-linux:
    name: Build (Linux)
    runs-on: ubuntu-latest
    needs: test-linux
    strategy:
      fail-fast: false
      matrix:
        optimize: [Debug, ReleaseSafe, ReleaseFast, ReleaseSmall]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libvulkan-dev \
            libwayland-dev \
            libfreetype-dev \
            libharfbuzz-dev \
            libfontconfig-dev \
            libpng-dev \
            libdbus-1-dev

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Cache Zig
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/zig
            zig-cache
          key: zig-cache-linux-${{ matrix.optimize }}-${{ hashFiles('build.zig', 'build.zig.zon') }}
          restore-keys: |
            zig-cache-linux-${{ matrix.optimize }}-
            zig-cache-linux-

      - name: Build (${{ matrix.optimize }})
        run: zig build -Doptimize=${{ matrix.optimize }} -Dskip-shader-compile=true

  # ==========================================================================
  # macOS Build (Multiple Optimization Levels)
  # ==========================================================================
  build-macos:
    name: Build (macOS)
    runs-on: macos-latest
    needs: test-macos
    strategy:
      fail-fast: false
      matrix:
        optimize: [Debug, ReleaseSafe, ReleaseFast]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Cache Zig
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/zig
            zig-cache
          key: zig-cache-macos-${{ matrix.optimize }}-${{ hashFiles('build.zig', 'build.zig.zon') }}
          restore-keys: |
            zig-cache-macos-${{ matrix.optimize }}-
            zig-cache-macos-

      - name: Build (${{ matrix.optimize }})
        run: zig build -Doptimize=${{ matrix.optimize }}

  # ==========================================================================
  # WebAssembly Build
  # ==========================================================================
  build-wasm:
    name: Build (WASM)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Cache Zig
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/zig
            zig-cache
          key: zig-cache-wasm-${{ hashFiles('build.zig', 'build.zig.zon') }}
          restore-keys: |
            zig-cache-wasm-

      - name: Build WASM (showcase)
        run: zig build wasm

      - name: Build WASM examples
        run: |
          zig build wasm-counter
          zig build wasm-dynamic-counters
          zig build wasm-pomodoro
          zig build wasm-layout
          zig build wasm-select

      - name: Upload WASM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wasm-build
          path: zig-out/web/
          retention-days: 7

  # ==========================================================================
  # Benchmarks (macOS)
  # ==========================================================================
  bench-macos:
    name: Benchmarks (macOS)
    runs-on: macos-latest
    needs: test-macos
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Cache Zig
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/zig
            zig-cache
          key: zig-cache-bench-macos-${{ hashFiles('build.zig', 'build.zig.zon') }}
          restore-keys: |
            zig-cache-bench-macos-
            zig-cache-macos-

      - name: Run all benchmarks
        run: zig build bench-all -Dbench-json-dir=bench-results

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bench-macos
          path: bench-results/
          retention-days: 90

  # ==========================================================================
  # Benchmark Regression Gate (PR only)
  # ==========================================================================
  # Compares current PR benchmarks against the most recent successful main
  # run.  Uses continue-on-error so regressions surface as warnings, not
  # blockers â€” promote to required once you trust the signal on shared
  # runners.  The 15% default threshold (in bench-compare) absorbs CI noise.
  bench-gate:
    name: Benchmark Gate (macOS)
    runs-on: macos-14
    if: github.event_name == 'pull_request'
    needs: test-macos
    continue-on-error: true
    permissions:
      actions: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Cache Zig
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/zig
            zig-cache
          key: zig-cache-bench-gate-${{ hashFiles('build.zig', 'build.zig.zon') }}
          restore-keys: |
            zig-cache-bench-gate-
            zig-cache-bench-macos-
            zig-cache-macos-

      # Find the latest successful CI run on main and download its macOS
      # benchmark artifact.  If no run exists or the artifact expired,
      # skip comparison gracefully â€” the PR still gets benchmark numbers.
      - name: Download baseline from main
        id: baseline
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          RUN_ID=$(gh api \
            "repos/${{ github.repository }}/actions/workflows/ci.yml/runs?branch=main&status=success&per_page=1" \
            --jq '.workflow_runs[0].id // empty')

          if [ -z "$RUN_ID" ]; then
            echo "No successful main run found â€” skipping comparison."
            echo "has_baseline=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Downloading baseline from main run $RUN_IDâ€¦"
          if ! gh run download "$RUN_ID" --name bench-macos --dir baseline/; then
            echo "Artifact not found or expired â€” skipping comparison."
            echo "has_baseline=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "has_baseline=true" >> "$GITHUB_OUTPUT"
          echo "baseline_run_id=$RUN_ID" >> "$GITHUB_OUTPUT"
          ls -la baseline/

      - name: Run benchmarks
        run: zig build bench-all -Dbench-json-dir=current/

      # Compare each module independently.  bench-compare exits 1 on
      # regression, 2 on usage/load errors.  We track per-module results
      # so the summary tells you exactly which module regressed.
      - name: Compare against baseline
        if: steps.baseline.outputs.has_baseline == 'true'
        id: compare
        run: |
          set -uo pipefail

          FAILED=0
          : > bench-report.txt

          for module in core layout context text; do
            BASELINE=$(ls baseline/*-*-${module}-benchmarks-*.json 2>/dev/null | head -1)
            CURRENT=$(ls current/*-*-${module}-benchmarks-*.json 2>/dev/null | head -1)

            if [ -z "$BASELINE" ]; then
              echo "âš  No baseline found for ${module} â€” skipping."
              continue
            fi
            if [ -z "$CURRENT" ]; then
              echo "âš  No current result found for ${module} â€” skipping."
              continue
            fi

            echo ""
            echo "â•â•â• Comparing ${module} â•â•â•"

            # bench-compare prints to stderr; merge into stdout for capture.
            if zig build bench-compare -- "$BASELINE" "$CURRENT" 2>&1 | tee -a bench-report.txt; then
              echo "âœ… ${module}: OK"
            else
              FAILED=1
              echo "ðŸ”´ ${module}: REGRESSION DETECTED"
            fi
          done

          exit $FAILED

      # Always post the comparison table to the Actions job summary so
      # reviewers can inspect numbers without digging through logs.
      - name: Post benchmark summary
        if: always() && steps.baseline.outputs.has_baseline == 'true'
        run: |
          {
            echo "## Benchmark Comparison"
            echo ""
            if [ -s bench-report.txt ]; then
              echo "<details><summary>Full comparison output</summary>"
              echo ""
              echo '```'
              cat bench-report.txt
              echo '```'
              echo ""
              echo "</details>"
            else
              echo "_No comparison data produced._"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  # ==========================================================================
  # Valgrind Memory Leak Detection
  # ==========================================================================
  valgrind:
    name: Valgrind
    runs-on: ubuntu-latest
    needs: test-linux
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            valgrind \
            libc6-dbg \
            libvulkan-dev \
            libwayland-dev \
            libfreetype-dev \
            libharfbuzz-dev \
            libfontconfig-dev \
            libpng-dev \
            libdbus-1-dev

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Cache Zig
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/zig
            zig-cache
          key: zig-cache-valgrind-${{ hashFiles('build.zig', 'build.zig.zon') }}
          restore-keys: |
            zig-cache-valgrind-
            zig-cache-linux-

      - name: Run tests under valgrind
        run: zig build test-valgrind -Dskip-shader-compile=true

  # ==========================================================================
  # Code Formatting
  # ==========================================================================
  zig-fmt:
    name: Zig Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Check formatting
        run: zig fmt --check src/ charts/
